<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>irt.distributions &mdash; Implicit Reparametrization Trick  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Implicit Reparametrization Trick
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main Info:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../info.html">Implicit Reparametrization Trick</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info.html#description">Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info.html#scope">Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info.html#stack">Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info.html#usage">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info.html#links">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Packages:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../distributions.html">Distributions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Implicit Reparametrization Trick</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">irt.distributions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for irt.distributions</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: allow-untyped-defs</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Real</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.autograd.functional</span> <span class="kn">import</span> <span class="n">jacobian</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Bernoulli</span><span class="p">,</span>
    <span class="n">Binomial</span><span class="p">,</span>
    <span class="n">ContinuousBernoulli</span><span class="p">,</span>
    <span class="n">Distribution</span><span class="p">,</span>
    <span class="n">Geometric</span><span class="p">,</span>
    <span class="n">NegativeBinomial</span><span class="p">,</span>
    <span class="n">RelaxedBernoulli</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch.distributions.exp_family</span> <span class="kn">import</span> <span class="n">ExponentialFamily</span>
<span class="kn">from</span> <span class="nn">torch.distributions.utils</span> <span class="kn">import</span> <span class="n">broadcast_all</span><span class="p">,</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">torch.types</span> <span class="kn">import</span> <span class="n">_size</span>

<span class="n">default_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span>


<div class="viewcode-block" id="Beta"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Beta">[docs]</a><span class="k">class</span> <span class="nc">Beta</span><span class="p">(</span><span class="n">ExponentialFamily</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Beta distribution parameterized by :attr:`concentration1` and :attr:`concentration0`.</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; m = Beta(torch.tensor([0.5]), torch.tensor([0.5]))</span>
<span class="sd">        &gt;&gt;&gt; m.sample()</span>
<span class="sd">        tensor([0.1046])</span>

<span class="sd">    Args:</span>
<span class="sd">        concentration1 (float or Tensor): 1st concentration parameter of the distribution</span>
<span class="sd">            (often referred to as alpha)</span>
<span class="sd">        concentration0 (float or Tensor): 2nd concentration parameter of the distribution</span>
<span class="sd">            (often referred to as beta)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arg_constraints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;concentration1&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
        <span class="s2">&quot;concentration0&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">unit_interval</span>
    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">concentration1</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">concentration0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">validate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Beta distribution with the given concentration parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            concentration1: First concentration parameter (alpha).</span>
<span class="sd">            concentration0: Second concentration parameter (beta).</span>
<span class="sd">            validate_args: If True, validates the distribution&#39;s parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">=</span> <span class="n">concentration1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span> <span class="o">=</span> <span class="n">concentration0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma1</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">concentration1</span><span class="p">),</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma0</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">concentration0</span><span class="p">),</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirichlet</span> <span class="o">=</span> <span class="n">Dirichlet</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gamma0</span><span class="o">.</span><span class="n">_batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>

<div class="viewcode-block" id="Beta.expand"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Beta.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Beta&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expands the Beta distribution to a new batch shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_shape: Desired batch shape.</span>
<span class="sd">            _instance: Instance to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new Beta distribution instance with expanded parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_checked_instance</span><span class="p">(</span><span class="n">Beta</span><span class="p">,</span> <span class="n">_instance</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_gamma1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma1</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_gamma0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma0</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Beta</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_validate_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mean of the Beta distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Mean of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mode of the Beta distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Mode of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the variance of the Beta distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Variance of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span> <span class="o">/</span> <span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

<div class="viewcode-block" id="Beta.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Beta.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a reparameterized sample from the Beta distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_shape (_size): Shape of the sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Sample from the Beta distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma1</span><span class="o">.</span><span class="n">rsample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma0</span><span class="o">.</span><span class="n">rsample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z1</span> <span class="o">/</span> <span class="p">(</span><span class="n">z1</span> <span class="o">+</span> <span class="n">z0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Beta.log_prob"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Beta.log_prob">[docs]</a>    <span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log probability density of a value under the Beta distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: Value to evaluate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Log probability of the value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">heads_tails</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">value</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">value</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirichlet</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">heads_tails</span><span class="p">)</span></div>

<div class="viewcode-block" id="Beta.entropy"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Beta.entropy">[docs]</a>    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the entropy of the Beta distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Entropy of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirichlet</span><span class="o">.</span><span class="n">entropy</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_natural_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the natural parameters of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Natural parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration0</span>

    <span class="k">def</span> <span class="nf">_log_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log normalizer for the natural parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Parameter 1.</span>
<span class="sd">            y: Parameter 2.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Log normalizer value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dirichlet"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Dirichlet">[docs]</a><span class="k">class</span> <span class="nc">Dirichlet</span><span class="p">(</span><span class="n">ExponentialFamily</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dirichlet distribution parameterized by a concentration vector.</span>

<span class="sd">    The Dirichlet distribution is a multivariate generalization of the Beta distribution. It</span>
<span class="sd">    is commonly used in Bayesian statistics, particularly for modeling proportions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arg_constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">independent</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">simplex</span>
    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">validate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Dirichlet distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            concentration: Positive concentration parameter vector (alpha).</span>
<span class="sd">            validate_args: If True, validates the distribution&#39;s parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">numel</span><span class="p">(</span><span class="n">concentration</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`concentration` parameter must be at least one-dimensional.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">concentration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">))</span>
        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">event_shape</span> <span class="o">=</span> <span class="n">concentration</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">concentration</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">event_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mean of the Dirichlet distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mean vector, calculated as `concentration / concentration.sum(-1, keepdim=True)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mode of the Dirichlet distribution.</span>

<span class="sd">        Note:</span>
<span class="sd">            - The mode is defined only when all concentration values are &gt; 1.</span>
<span class="sd">            - For concentrations ≤ 1, the mode vector is clamped to enforce positivity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mode vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">concentration_minus_one</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">concentration_minus_one</span> <span class="o">/</span> <span class="n">concentration_minus_one</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mode</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">concentration_minus_one</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mode</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the variance of the Dirichlet distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Variance vector for each component.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">total_concentration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">total_concentration</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_concentration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Dirichlet.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Dirichlet.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a reparameterized sample from the Dirichlet distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_shape (_size): Desired sample shape.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: A reparameterized sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rsample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>  <span class="c1"># Sample from underlying Gamma distribution</span>

        <span class="k">return</span> <span class="n">z</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dirichlet.log_prob"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Dirichlet.log_prob">[docs]</a>    <span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log probability density for a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): Value to evaluate the log probability at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Log probability density of the value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">xlogy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Dirichlet.entropy"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Dirichlet.entropy">[docs]</a>    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the entropy of the Dirichlet distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Entropy of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">total_concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">total_concentration</span><span class="p">)</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">total_concentration</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="n">total_concentration</span><span class="p">)</span>
            <span class="o">-</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Dirichlet.expand"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Dirichlet.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Dirichlet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dirichlet&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expands the distribution parameters to a new batch shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_shape (torch.Size): Desired batch shape.</span>
<span class="sd">            _instance (Optional): Instance to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new Dirichlet distribution instance with expanded parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_checked_instance</span><span class="p">(</span><span class="n">Dirichlet</span><span class="p">,</span> <span class="n">_instance</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_shape</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Dirichlet</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_validate_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_natural_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the natural parameters of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Natural parameter tuple `(concentration,)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">_log_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log normalizer for the natural parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (torch.Tensor): Natural parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Log normalizer value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">lgamma</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="StudentT"><a class="viewcode-back" href="../../distributions.html#irt.distributions.StudentT">[docs]</a><span class="k">class</span> <span class="nc">StudentT</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Student&#39;s t-distribution parameterized by degrees of freedom (df), location (loc), and scale (scale).</span>

<span class="sd">    This distribution is commonly used for robust statistical modeling, particularly when the data</span>
<span class="sd">    may have outliers or heavier tails than a Normal distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arg_constraints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
        <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
        <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">real</span>
    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">validate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Student&#39;s t-distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (torch.Tensor): Degrees of freedom (must be positive).</span>
<span class="sd">            loc (float or torch.Tensor): Location parameter (default: 0.0).</span>
<span class="sd">            scale (float or torch.Tensor): Scale parameter (default: 1.0).</span>
<span class="sd">            validate_args (Optional[bool]): If True, validates distribution parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">broadcast_all</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mean of the distribution.</span>

<span class="sd">        Note: The mean is undefined when `df &lt;= 1`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Mean of the distribution, or NaN for undefined cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">contiguous_format</span><span class="p">)</span>
        <span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>  <span class="c1"># Mean is undefined for df &lt;= 1</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mode of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Mode of the distribution, which is equal to `loc`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the variance of the distribution.</span>

<span class="sd">        Note:</span>
<span class="sd">            - Variance is infinite for 1 &lt; df &lt;= 2.</span>
<span class="sd">            - Variance is undefined (NaN) for df &lt;= 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Variance of the distribution, or appropriate values for edge cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">contiguous_format</span><span class="p">)</span>
        <span class="c1"># Variance for df &gt; 2</span>
        <span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Infinite variance for 1 &lt; df &lt;= 2</span>
        <span class="n">m</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="c1"># Undefined variance for df &lt;= 1</span>
        <span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span>

<div class="viewcode-block" id="StudentT.expand"><a class="viewcode-back" href="../../distributions.html#irt.distributions.StudentT.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StudentT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StudentT&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expands the distribution parameters to a new batch shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_shape (torch.Size): Desired batch size for the expanded distribution.</span>
<span class="sd">            _instance (Optional): Instance to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StudentT: A new StudentT distribution with expanded parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_checked_instance</span><span class="p">(</span><span class="n">StudentT</span><span class="p">,</span> <span class="n">_instance</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StudentT</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_validate_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span>
        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="StudentT.log_prob"><a class="viewcode-back" href="../../distributions.html#irt.distributions.StudentT.log_prob">[docs]</a>    <span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log probability density for a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): Value to evaluate the log probability at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Log probability density of the given value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">Z</span></div>

<div class="viewcode-block" id="StudentT.entropy"><a class="viewcode-back" href="../../distributions.html#irt.distributions.StudentT.entropy">[docs]</a>    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the entropy of the Student&#39;s t-distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Entropy of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lbeta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">))</span>
            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">lbeta</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms an input tensor `z` to a standardized form based on the location and scale.</span>

<span class="sd">        Args:</span>
<span class="sd">            z (torch.Tensor): Input tensor to transform.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Transformed tensor representing the standardized form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

    <span class="k">def</span> <span class="nf">_d_transform_d_z</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the derivative of the transform function with respect to `z`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Reciprocal of the scale, representing the gradient for reparameterization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

<div class="viewcode-block" id="StudentT.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.StudentT.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a reparameterized sample from the Student&#39;s t-distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_shape (_size): Shape of the sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Reparameterized sample, enabling gradient tracking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extended_shape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extended_shape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">))</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rsample</span><span class="p">()</span>

        <span class="c1"># Sample from Normal distribution (shape must match after broadcasting)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">rsample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>  <span class="c1"># Standardize the sample</span>
        <span class="n">surrogate_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">transform</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_transform_d_z</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># Compute surrogate gradient</span>

        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">surrogate_x</span> <span class="o">-</span> <span class="n">surrogate_x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="Gamma"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Gamma">[docs]</a><span class="k">class</span> <span class="nc">Gamma</span><span class="p">(</span><span class="n">ExponentialFamily</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gamma distribution parameterized by `concentration` (shape) and `rate` (inverse scale).</span>
<span class="sd">    The Gamma distribution is often used to model the time until an event occurs,</span>
<span class="sd">    and it is a continuous probability distribution defined for non-negative real values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arg_constraints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
        <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">nonnegative</span>
    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_mean_carrier_measure</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">validate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Gamma distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            concentration (torch.Tensor): Shape parameter of the distribution (often referred to as alpha).</span>
<span class="sd">            rate (torch.Tensor): Rate parameter (inverse of scale, often referred to as beta).</span>
<span class="sd">            validate_args (Optional[bool]): If True, validates the distribution&#39;s parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">broadcast_all</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mean of the Gamma distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Mean of the distribution, calculated as `concentration / rate`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the mode of the Gamma distribution.</span>

<span class="sd">        Note:</span>
<span class="sd">            - The mode is defined only for `concentration &gt; 1`. For `concentration &lt;= 1`,</span>
<span class="sd">              the mode is clamped to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Mode of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the variance of the Gamma distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Variance of the distribution, calculated as `concentration / rate^2`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="Gamma.expand"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Gamma.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Gamma&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expands the distribution parameters to a new batch shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_shape (torch.Size): Desired batch shape.</span>
<span class="sd">            _instance (Optional): Instance to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Gamma: A new Gamma distribution instance with expanded parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_checked_instance</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">_instance</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_validate_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span>
        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="Gamma.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Gamma.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a reparameterized sample from the Gamma distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_shape (_size): Shape of the sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: A reparameterized sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extended_shape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Generate a sample using the underlying C++ implementation for efficiency</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_standard_gamma</span><span class="p">(</span><span class="n">concentration</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="c1"># Detach u for surrogate computation</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">*</span> <span class="n">rate</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">/</span> <span class="n">rate</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

        <span class="c1"># Ensure numerical stability for gradients</span>
        <span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">tiny</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Gamma.log_prob"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Gamma.log_prob">[docs]</a>    <span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log probability density for a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): Value to evaluate the log probability at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Log probability density of the given value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">xlogy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">xlogy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">*</span> <span class="n">value</span>
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Gamma.entropy"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Gamma.entropy">[docs]</a>    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the entropy of the Gamma distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Entropy of the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_natural_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the natural parameters of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Tuple of natural parameters `(concentration - 1, -rate)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

    <span class="k">def</span> <span class="nf">_log_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log normalizer for the natural parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (torch.Tensor): First natural parameter.</span>
<span class="sd">            y (torch.Tensor): Second natural parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Log normalizer value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">())</span>

<div class="viewcode-block" id="Gamma.cdf"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Gamma.cdf">[docs]</a>    <span class="k">def</span> <span class="nf">cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the cumulative distribution function (CDF) for the Gamma distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): Value to evaluate the CDF at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: CDF of the given value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammainc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Normal"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal">[docs]</a><span class="k">class</span> <span class="nc">Normal</span><span class="p">(</span><span class="n">ExponentialFamily</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the Normal (Gaussian) distribution with specified mean (loc) and standard deviation (scale).</span>
<span class="sd">    Inherits from PyTorch&#39;s ExponentialFamily distribution class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">arg_constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">}</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">real</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loc</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">validate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Normal distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            loc (torch.Tensor): Mean (location) parameter of the distribution.</span>
<span class="sd">            scale (torch.Tensor): Standard deviation (scale) parameter of the distribution.</span>
<span class="sd">            validate_args (Optional[bool]): If True, checks the distribution parameters for validity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">broadcast_all</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="c1"># Determine batch shape based on the type of `loc` and `scale`.</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="n">validate_args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the mean of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The mean (location) parameter `loc`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the mode of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The mode (equal to `loc` in a Normal distribution).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stddev</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the standard deviation of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The standard deviation (scale) parameter `scale`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the variance of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The variance, computed as `scale ** 2`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="Normal.entropy"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.entropy">[docs]</a>    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the entropy of the distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The entropy of the Normal distribution, which is a measure of uncertainty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span></div>

<div class="viewcode-block" id="Normal.cdf"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.cdf">[docs]</a>    <span class="k">def</span> <span class="nf">cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the cumulative distribution function (CDF) of the distribution at a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): The value at which to evaluate the CDF.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The probability that a random variable from the distribution is less than or equal to `value`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">erf</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span></div>

<div class="viewcode-block" id="Normal.expand"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Normal&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expands the distribution parameters to a new batch shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_shape (torch.Size): Desired batch size for the expanded distribution.</span>
<span class="sd">            _instance (Optional): Instance to check for validity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Normal: A new Normal distribution with parameters expanded to the specified batch shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_checked_instance</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span> <span class="n">_instance</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_validate_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span>
        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="Normal.icdf"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.icdf">[docs]</a>    <span class="k">def</span> <span class="nf">icdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the inverse cumulative distribution function (quantile function) at a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): The probability value at which to evaluate the inverse CDF.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The quantile corresponding to `value`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Normal.log_prob"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.log_prob">[docs]</a>    <span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the log probability density of the distribution at a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (torch.Tensor): The value at which to evaluate the log probability.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The log probability density at `value`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">log_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">Real</span><span class="p">)</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_scale</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms an input tensor `z` to a standardized form based on the mean and scale.</span>

<span class="sd">        Args:</span>
<span class="sd">            z (torch.Tensor): Input tensor to transform.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The transformed tensor, representing the standardized normal form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

    <span class="k">def</span> <span class="nf">_d_transform_d_z</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the derivative of the transform function with respect to `z`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The reciprocal of the scale, representing the gradient for reparameterization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

<div class="viewcode-block" id="Normal.sample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a sample from the Normal distribution using `torch.normal`.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_shape (torch.Size): Shape of the sample to generate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: A tensor with samples from the Normal distribution, detached from the computation graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extended_shape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span></div>

<div class="viewcode-block" id="Normal.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.Normal.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a reparameterized sample from the Normal distribution, enabling gradient backpropagation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: A tensor containing a reparameterized sample, useful for gradient-based optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sample a point from the distribution</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="c1"># Transform the sample to standard normal form</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Compute a surrogate value for backpropagation</span>
        <span class="n">surrogate_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">transform</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_transform_d_z</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="c1"># Return the sample with gradient tracking enabled</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">surrogate_x</span> <span class="o">-</span> <span class="n">surrogate_x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="MixtureSameFamily"><a class="viewcode-back" href="../../distributions.html#irt.distributions.MixtureSameFamily">[docs]</a><span class="k">class</span> <span class="nc">MixtureSameFamily</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">MixtureSameFamily</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a mixture of distributions from the same family.</span>
<span class="sd">    Supporting reparameterized sampling for gradient-based optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the MixtureSameFamily distribution and checks if the component distributions.</span>
<span class="sd">        Support reparameterized sampling (required for `rsample`).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the component distributions do not support reparameterized sampling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span><span class="o">.</span><span class="n">has_rsample</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot reparameterize a mixture of non-reparameterizable components.&quot;</span><span class="p">)</span>

        <span class="c1"># Define a list of discrete distributions for checking in `_log_cdf`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discrete_distributions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Bernoulli</span><span class="p">,</span>
            <span class="n">Binomial</span><span class="p">,</span>
            <span class="n">ContinuousBernoulli</span><span class="p">,</span>
            <span class="n">Geometric</span><span class="p">,</span>
            <span class="n">NegativeBinomial</span><span class="p">,</span>
            <span class="n">RelaxedBernoulli</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="MixtureSameFamily.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.MixtureSameFamily.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a reparameterized sample from the mixture of distributions.</span>

<span class="sd">        This method generates a sample, applies a distributional transformation,</span>
<span class="sd">        and computes a surrogate sample to enable gradient flow during optimization.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_shape (torch.Size): The shape of the sample to generate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: A reparameterized sample with gradients enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate a sample from the mixture distribution</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="o">=</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">event_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event_size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For multi-dimensional events, use reshaped distributional transformations</span>
            <span class="k">def</span> <span class="nf">reshaped_dist_trans</span><span class="p">(</span><span class="n">input_x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributional_transform</span><span class="p">(</span><span class="n">input_x</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">event_size</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">reshaped_dist_trans_summed</span><span class="p">(</span><span class="n">x_2d</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reshaped_dist_trans</span><span class="p">(</span><span class="n">x_2d</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">x_2d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">event_size</span><span class="p">))</span>
            <span class="n">transform_2d</span> <span class="o">=</span> <span class="n">reshaped_dist_trans</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">jacobian</span><span class="p">(</span><span class="n">reshaped_dist_trans_summed</span><span class="p">,</span> <span class="n">x_2d</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">movedim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">surrogate_x_2d</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">transform_2d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">upper</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">surrogate_x</span> <span class="o">=</span> <span class="n">surrogate_x_2d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For one-dimensional events, apply the standard distributional transformation</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributional_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">log_prob_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_ndims</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log_prob_x</span> <span class="o">=</span> <span class="n">log_prob_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">log_prob_x</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_ndims</span><span class="p">)</span>

            <span class="n">surrogate_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">transform</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">log_prob_x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">surrogate_x</span> <span class="o">-</span> <span class="n">surrogate_x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_distributional_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a distributional transformation to the input sample `x`, using cumulative</span>
<span class="sd">        distribution functions (CDFs) and posterior weights.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (torch.Tensor): The input sample to transform.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The transformed tensor based on the mixture model&#39;s CDFs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Independent</span><span class="p">):</span>
            <span class="n">univariate_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span><span class="o">.</span><span class="n">base_dist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">univariate_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span>

        <span class="c1"># Expand input tensor and compute log-probabilities in each component</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [S, B, 1, E]</span>
        <span class="n">log_prob_x</span> <span class="o">=</span> <span class="n">univariate_components</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [S, B, K, E]</span>

        <span class="n">event_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event_size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># CDF transformation for multi-dimensional events</span>
            <span class="n">cumsum_log_prob_x</span> <span class="o">=</span> <span class="n">log_prob_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">event_size</span><span class="p">)</span>
            <span class="n">cumsum_log_prob_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">cumsum_log_prob_x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cumsum_log_prob_x</span> <span class="o">=</span> <span class="n">cumsum_log_prob_x</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">shifts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cumsum_log_prob_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cumsum_log_prob_x</span> <span class="o">=</span> <span class="n">cumsum_log_prob_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">log_prob_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">logits_mix_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_mixture_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mixture_distribution</span><span class="o">.</span><span class="n">logits</span><span class="p">)</span>
            <span class="n">log_posterior_weights_x</span> <span class="o">=</span> <span class="n">logits_mix_prob</span> <span class="o">+</span> <span class="n">cumsum_log_prob_x</span>

            <span class="n">component_axis</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_ndims</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">cdf_x</span> <span class="o">=</span> <span class="n">univariate_components</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">posterior_weights_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">log_posterior_weights_x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">component_axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CDF transformation for one-dimensional events</span>
            <span class="n">log_posterior_weights_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mixture_distribution</span><span class="o">.</span><span class="n">logits</span>
            <span class="n">component_axis</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_ndims</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">cdf_x</span> <span class="o">=</span> <span class="n">univariate_components</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">posterior_weights_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">log_posterior_weights_x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">posterior_weights_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_mixture_dimensions</span><span class="p">(</span><span class="n">posterior_weights_x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">posterior_weights_x</span> <span class="o">*</span> <span class="n">cdf_x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">component_axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the logarithm of the cumulative distribution function (CDF) for the mixture distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (torch.Tensor): The input tensor for which to compute the log CDF.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The log CDF values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Independent</span><span class="p">):</span>
            <span class="n">univariate_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span><span class="o">.</span><span class="n">base_dist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">univariate_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_distribution</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">univariate_components</span><span class="p">,</span> <span class="s2">&quot;_log_cdf&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="n">log_cdf_x</span> <span class="o">=</span> <span class="n">univariate_components</span><span class="o">.</span><span class="n">_log_cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_cdf_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">univariate_components</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">univariate_components</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discrete_distributions</span><span class="p">)):</span>
            <span class="n">log_mix_prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mixture_distribution</span><span class="o">.</span><span class="n">logits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_mix_prob</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mixture_distribution</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">log_cdf_x</span> <span class="o">+</span> <span class="n">log_mix_prob</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_eval_poly</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">coef</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a polynomial at given points.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: Input tensor.</span>
<span class="sd">        coeffs: Polynomial coefficients.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Evaluated polynomial tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">coef</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="n">_I0_COEF_SMALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="mf">3.5156229</span><span class="p">,</span>
    <span class="mf">3.0899424</span><span class="p">,</span>
    <span class="mf">1.2067492</span><span class="p">,</span>
    <span class="mf">0.2659732</span><span class="p">,</span>
    <span class="mf">0.360768e-1</span><span class="p">,</span>
    <span class="mf">0.45813e-2</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">_I0_COEF_LARGE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.39894228</span><span class="p">,</span>
    <span class="mf">0.1328592e-1</span><span class="p">,</span>
    <span class="mf">0.225319e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.157565e-2</span><span class="p">,</span>
    <span class="mf">0.916281e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.2057706e-1</span><span class="p">,</span>
    <span class="mf">0.2635537e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.1647633e-1</span><span class="p">,</span>
    <span class="mf">0.392377e-2</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">_I1_COEF_SMALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.5</span><span class="p">,</span>
    <span class="mf">0.87890594</span><span class="p">,</span>
    <span class="mf">0.51498869</span><span class="p">,</span>
    <span class="mf">0.15084934</span><span class="p">,</span>
    <span class="mf">0.2658733e-1</span><span class="p">,</span>
    <span class="mf">0.301532e-2</span><span class="p">,</span>
    <span class="mf">0.32411e-3</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">_I1_COEF_LARGE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.39894228</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.3988024e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.362018e-2</span><span class="p">,</span>
    <span class="mf">0.163801e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.1031555e-1</span><span class="p">,</span>
    <span class="mf">0.2282967e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.2895312e-1</span><span class="p">,</span>
    <span class="mf">0.1787654e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.420059e-2</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_COEF_SMALL</span> <span class="o">=</span> <span class="p">[</span><span class="n">_I0_COEF_SMALL</span><span class="p">,</span> <span class="n">_I1_COEF_SMALL</span><span class="p">]</span>
<span class="n">_COEF_LARGE</span> <span class="o">=</span> <span class="p">[</span><span class="n">_I0_COEF_LARGE</span><span class="p">,</span> <span class="n">_I1_COEF_LARGE</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_log_modified_bessel_fn</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the logarithm of the modified Bessel function of the first kind.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor, must be positive.</span>
<span class="sd">        order: Order of the Bessel function (0 or 1).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Logarithm of the Bessel function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order must be 0 or 1.&quot;</span><span class="p">)</span>

    <span class="c1"># compute small solution</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">3.75</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">small</span> <span class="o">=</span> <span class="n">_eval_poly</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">_COEF_SMALL</span><span class="p">[</span><span class="n">order</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">small</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">small</span>
    <span class="n">small</span> <span class="o">=</span> <span class="n">small</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

    <span class="c1"># compute large solution</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mf">3.75</span> <span class="o">/</span> <span class="n">x</span>
    <span class="n">large</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">+</span> <span class="n">_eval_poly</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">_COEF_LARGE</span><span class="p">[</span><span class="n">order</span><span class="p">])</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">3.75</span><span class="p">,</span> <span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script_if_tracing</span>
<span class="k">def</span> <span class="nf">_rejection_sample</span><span class="p">(</span>
    <span class="n">loc</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">proposal_r</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform rejection sampling for the von Mises distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        loc: Location parameter.</span>
<span class="sd">        concentration: Concentration parameter.</span>
<span class="sd">        proposal_r: Precomputed proposal parameter.</span>
<span class="sd">        x: Tensor to fill with samples.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor of samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">loc</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">3</span><span class="p">,)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">loc</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">loc</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u1</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">proposal_r</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">proposal_r</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">concentration</span> <span class="o">*</span> <span class="p">(</span><span class="n">proposal_r</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">u2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">c</span> <span class="o">/</span> <span class="n">u2</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">accept</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="p">(</span><span class="n">u3</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">acos</span><span class="p">(),</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">done</span> <span class="o">|</span> <span class="n">accept</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">loc</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>


<div class="viewcode-block" id="VonMises"><a class="viewcode-back" href="../../distributions.html#irt.distributions.VonMises">[docs]</a><span class="k">class</span> <span class="nc">VonMises</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Von Mises distribution class for circular data.&quot;&quot;&quot;</span>

    <span class="n">arg_constraints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
        <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">real</span>
    <span class="n">has_rsample</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loc</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">validate_args</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            loc: loc parameter of the distribution.</span>
<span class="sd">            concentration: concentration parameter of the distribution.</span>
<span class="sd">            validate_args: If True, checks the distribution parameters for validity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">broadcast_all</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">concentration</span><span class="p">)</span>
        <span class="n">batch_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(),</span> <span class="n">validate_args</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_proposal_r</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the proposal parameter for sampling.&quot;&quot;&quot;</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">kappa</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">)</span>
        <span class="n">_proposal_r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rho</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span>

        <span class="c1"># second order Taylor expansion around 0 for small kappa</span>
        <span class="n">_proposal_r_taylor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">kappa</span> <span class="o">+</span> <span class="n">kappa</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">_proposal_r_taylor</span><span class="p">,</span> <span class="n">_proposal_r</span><span class="p">)</span>

<div class="viewcode-block" id="VonMises.log_prob"><a class="viewcode-back" href="../../distributions.html#irt.distributions.VonMises.log_prob">[docs]</a>    <span class="k">def</span> <span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the log probability of the given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: Tensor of values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tensor of log probabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">log_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span>
        <span class="n">log_prob</span> <span class="o">=</span> <span class="n">log_prob</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">_log_modified_bessel_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">log_prob</span></div>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The sampling algorithm for the von Mises distribution is based on the</span>
<span class="sd">        following paper: D.J. Best and N.I. Fisher, &quot;Efficient simulation of the</span>
<span class="sd">        von Mises distribution.&quot; Applied Statistics (1979): 152-157.</span>

<span class="sd">        Sampling is always done in double precision internally to avoid a hang</span>
<span class="sd">        in _rejection_sample() for small values of the concentration, which</span>
<span class="sd">        starts to happen for single precision around 1e-4 (see issue #88443).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extended_shape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loc</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_rejection_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proposal_r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<div class="viewcode-block" id="VonMises.rsample"><a class="viewcode-back" href="../../distributions.html#irt.distributions.VonMises.rsample">[docs]</a>    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="p">:</span> <span class="n">_size</span> <span class="o">=</span> <span class="n">default_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate reparameterized samples from the distribution&quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extended_shape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">_VonMisesSampler</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proposal_r</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

        <span class="c1"># Map the samples to [-pi, pi].</span>
        <span class="k">return</span> <span class="n">samples</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">samples</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mean of the distribution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Variance of the distribution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="mi">1</span>
            <span class="o">-</span> <span class="p">(</span>
                <span class="n">_log_modified_bessel_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">_log_modified_bessel_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="p">)</span></div>


<span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script_if_tracing</span>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_rejection_rsample</span><span class="p">(</span><span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">proposal_r</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform rejection sampling to draw samples from the von Mises distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        concentration (torch.Tensor): Concentration parameter (kappa) of the distribution.</span>
<span class="sd">        proposal_r (torch.Tensor): Proposal distribution parameter.</span>
<span class="sd">        shape (torch.Size): Desired shape of the samples.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Samples from the von Mises distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">concentration</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">concentration</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">concentration</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">3</span><span class="p">,)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">concentration</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">concentration</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u1</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">proposal_r</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">proposal_r</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">concentration</span> <span class="o">*</span> <span class="p">(</span><span class="n">proposal_r</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">u2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">c</span> <span class="o">/</span> <span class="n">u2</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">accept</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="p">(</span><span class="n">u3</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">acos</span><span class="p">(),</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">done</span> <span class="o">|</span> <span class="n">accept</span>
    <span class="k">return</span> <span class="n">x</span>


<div class="viewcode-block" id="cosxm1"><a class="viewcode-back" href="../../distributions.html#irt.distributions.cosxm1">[docs]</a><span class="k">def</span> <span class="nf">cosxm1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute cos(x) - 1 using a numerically stable formula.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (torch.Tensor): Input tensor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Output tensor, `cos(x) - 1`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">_VonMisesSampler</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">FunctionCtx</span><span class="p">,</span>
        <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">proposal_r</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform forward sampling using rejection sampling.</span>

<span class="sd">        Args:</span>
<span class="sd">            ctx (torch.autograd.function.FunctionCtx): Context object for saving tensors.</span>
<span class="sd">            concentration (torch.Tensor): Concentration parameter (kappa).</span>
<span class="sd">            proposal_r (torch.Tensor): Proposal distribution parameter.</span>
<span class="sd">            shape (torch.Size): Desired shape of the samples.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Samples from the von Mises distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">_rejection_rsample</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span> <span class="n">proposal_r</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span> <span class="n">proposal_r</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">samples</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">once_differentiable</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">FunctionCtx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute gradients for backward pass using implicit reparameterization.</span>

<span class="sd">        Args:</span>
<span class="sd">            ctx (torch.autograd.function.FunctionCtx): Context object containing saved tensors.</span>
<span class="sd">            grad_output (torch.Tensor): Gradient of the loss with respect to the output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[torch.Tensor, None, None]: Gradients with respect to the input tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">concentration</span><span class="p">,</span> <span class="n">proposal_r</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span>

        <span class="n">num_periods</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">samples</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
        <span class="n">x_mapped</span> <span class="o">=</span> <span class="n">samples</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_periods</span>

        <span class="c1"># Parameters from the paper</span>
        <span class="n">ck</span> <span class="o">=</span> <span class="mf">10.5</span>
        <span class="n">num_terms</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="c1"># Compute series and normal approximation</span>
        <span class="n">cdf_series</span><span class="p">,</span> <span class="n">dcdf_dconcentration_series</span> <span class="o">=</span> <span class="n">von_mises_cdf_series</span><span class="p">(</span><span class="n">x_mapped</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">num_terms</span><span class="p">)</span>
        <span class="n">cdf_normal</span><span class="p">,</span> <span class="n">dcdf_dconcentration_normal</span> <span class="o">=</span> <span class="n">von_mises_cdf_normal</span><span class="p">(</span><span class="n">x_mapped</span><span class="p">,</span> <span class="n">concentration</span><span class="p">)</span>
        <span class="n">use_series</span> <span class="o">=</span> <span class="n">concentration</span> <span class="o">&lt;</span> <span class="n">ck</span>
        <span class="c1"># cdf = torch.where(use_series, cdf_series, cdf_normal) + num_periods</span>
        <span class="n">dcdf_dconcentration</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_series</span><span class="p">,</span> <span class="n">dcdf_dconcentration_series</span><span class="p">,</span> <span class="n">dcdf_dconcentration_normal</span><span class="p">)</span>

        <span class="c1"># Compute CDF gradient terms</span>
        <span class="n">inv_prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">concentration</span> <span class="o">*</span> <span class="n">cosxm1</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">i0e</span><span class="p">(</span><span class="n">concentration</span><span class="p">))</span>
        <span class="n">grad_concentration</span> <span class="o">=</span> <span class="n">grad_output</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">dcdf_dconcentration</span> <span class="o">/</span> <span class="n">inv_prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grad_concentration</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<div class="viewcode-block" id="von_mises_cdf_series"><a class="viewcode-back" href="../../distributions.html#irt.distributions.von_mises_cdf_series">[docs]</a><span class="k">def</span> <span class="nf">von_mises_cdf_series</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">num_terms</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the CDF of the von Mises distribution using a series approximation.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (torch.Tensor): Input tensor.</span>
<span class="sd">        concentration (torch.Tensor): Concentration parameter (kappa).</span>
<span class="sd">        num_terms (int): Number of terms in the series.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[torch.Tensor, torch.Tensor]: CDF and its gradient with respect to concentration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dvn_dconcentration</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">num_terms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">drn_dconcentration</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">concentration</span> <span class="o">+</span> <span class="n">rn</span>
        <span class="n">ddenominator_dk</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">concentration</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">drn_dconcentration</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="n">drn_dconcentration</span> <span class="o">=</span> <span class="o">-</span><span class="n">ddenominator_dk</span> <span class="o">/</span> <span class="n">denominator</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">+</span> <span class="n">vn</span>
        <span class="n">vn</span> <span class="o">=</span> <span class="n">rn</span> <span class="o">*</span> <span class="n">multiplier</span>
        <span class="n">dvn_dconcentration</span> <span class="o">=</span> <span class="n">drn_dconcentration</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">+</span> <span class="n">rn</span> <span class="o">*</span> <span class="n">dvn_dconcentration</span>

        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">cdf</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">vn</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">dcdf_dconcentration</span> <span class="o">=</span> <span class="n">dvn_dconcentration</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">cdf_clipped</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">dcdf_dconcentration</span> <span class="o">*=</span> <span class="p">(</span><span class="n">cdf</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cdf</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cdf_clipped</span><span class="p">,</span> <span class="n">dcdf_dconcentration</span></div>


<div class="viewcode-block" id="cdf_func"><a class="viewcode-back" href="../../distributions.html#irt.distributions.cdf_func">[docs]</a><span class="k">def</span> <span class="nf">cdf_func</span><span class="p">(</span><span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Approximate the CDF of the von Mises distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        concentration (torch.Tensor): Concentration parameter (kappa).</span>
<span class="sd">        x (torch.Tensor): Input tensor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Approximate CDF values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the z value based on the approximation</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">i0e</span><span class="p">(</span><span class="n">concentration</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
    <span class="c1"># Apply corrections to z to improve the approximation</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">*</span> <span class="n">z</span>
    <span class="n">z4</span> <span class="o">=</span> <span class="n">z2</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="n">concentration</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="mf">56.0</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">z3</span> <span class="o">/</span> <span class="p">(((</span><span class="n">c</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">z2</span> <span class="o">-</span> <span class="mf">16.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">z4</span> <span class="o">+</span> <span class="p">(</span><span class="mf">7.0</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">z2</span> <span class="o">+</span> <span class="mf">167.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">z2</span> <span class="o">+</span> <span class="mf">3.0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># Use the standard normal distribution for the approximation</span>
    <span class="n">distrib</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">distrib</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span></div>


<div class="viewcode-block" id="von_mises_cdf_normal"><a class="viewcode-back" href="../../distributions.html#irt.distributions.von_mises_cdf_normal">[docs]</a><span class="k">def</span> <span class="nf">von_mises_cdf_normal</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">concentration</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the CDF of the von Mises distribution using a normal approximation.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (torch.Tensor): Input tensor.</span>
<span class="sd">        concentration (torch.Tensor): Concentration parameter (kappa).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[torch.Tensor, torch.Tensor]: CDF and its gradient with respect to concentration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
        <span class="n">concentration_</span> <span class="o">=</span> <span class="n">concentration</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">cdf_func</span><span class="p">(</span><span class="n">concentration_</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">cdf</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cdf</span><span class="p">))</span>  <span class="c1"># Compute gradients</span>
        <span class="n">dcdf_dconcentration</span> <span class="o">=</span> <span class="n">concentration_</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># Copy the gradient</span>
    <span class="c1"># Detach gradients to prevent further autograd tracking</span>
    <span class="n">concentration_</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">cdf</span><span class="p">,</span> <span class="n">dcdf_dconcentration</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Matvei Kreinin, Maria Nikitina, Petr Babkin, Irina Zaboryanskaya.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>